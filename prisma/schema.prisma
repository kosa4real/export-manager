generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int           @id @default(autoincrement())
  username     String        @unique @db.VarChar(50)
  email        String        @unique @db.VarChar(100)
  passwordHash String        @db.VarChar(255)
  role         UserRole      @default(STAFF)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  investorId   Int?          @unique
  dataRequests DataRequest[] @relation("CreatedBy")
  investor     Investor?     @relation("InvestorUser", fields: [investorId], references: [id])

  @@map("users")
}

model CoalSupplier {
  id          Int            @id @default(autoincrement())
  name        String         @unique @db.VarChar(100)
  contactInfo String?        @db.VarChar(100)
  email       String?        @db.VarChar(100)
  fullAddress String?
  status      SupplierStatus @default(ACTIVE)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  supplies    CoalSupply[]

  @@map("suppliers")
}

model CoalSupply {
  id            Int            @id @default(autoincrement())
  supplierId    Int
  supplyDate    DateTime
  quantityBags  Int
  unitPrice     Decimal        @db.Decimal(12, 2)
  amountPaid    Decimal        @db.Decimal(12, 2)
  paymentStatus PaymentStatus  @default(BALANCED)
  balanceAmount Decimal        @default(0) @db.Decimal(12, 2)
  gradeA        Int            @default(0)
  gradeB        Int            @default(0)
  rejectedBags  Int            @default(0)
  dustBags      Int            @default(0)
  woodBags      Int            @default(0)
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  supplier      CoalSupplier   @relation(fields: [supplierId], references: [id])
  exports       SupplyExport[]

  @@unique([supplierId, supplyDate])
  @@index([supplierId])
  @@index([supplyDate])
  @@map("supplies")
}

model ExportShipment {
  id                    Int            @id @default(autoincrement())
  exportDate            DateTime
  quantityBags          Int
  departureDate         DateTime
  arrivalDate           DateTime?
  destinationCountry    String         @db.VarChar(100)
  destinationCity       String         @db.VarChar(100)
  departureClearingAgent String?       @db.VarChar(100)
  departureClearingFee   Decimal?      @db.Decimal(12, 2)
  arrivalClearingAgent   String?       @db.VarChar(100)
  arrivalClearingFee     Decimal?      @db.Decimal(12, 2)
  clearingAgent         String?        @db.VarChar(100) // Keep for backward compatibility
  buyer                 String?        @db.VarChar(100)
  amountReceived        Decimal?       @db.Decimal(12, 2)
  clearingFee           Decimal?       @db.Decimal(12, 2) // Keep for backward compatibility
  netProfit             Decimal?       @db.Decimal(12, 2)
  containerNumber       String?        @unique @db.VarChar(50)
  status                ShipmentStatus @default(PENDING)
  notes                 String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  assignedInvestorId    Int?           @map("assigned_investor_id")
  assignedInvestor      Investor?      @relation("InvestorExports", fields: [assignedInvestorId], references: [id])
  supplies              SupplyExport[]

  @@index([exportDate])
  @@index([destinationCountry])
  @@index([departureDate])
  @@index([assignedInvestorId])
  @@map("exports")
}

model Investor {
  id                  Int              @id @default(autoincrement())
  name                String           @db.VarChar(100)
  contactInfo         String?          @db.VarChar(100)
  email               String?          @db.VarChar(100)
  investmentDate      DateTime
  amountInvested      Decimal          @db.Decimal(12, 2)
  currency            String           @default("USD") @db.VarChar(3)
  bankName            String           @db.VarChar(100)
  amountReceived      Decimal          @db.Decimal(12, 2)
  exchangeRate        Decimal          @db.Decimal(8, 4)
  profitShare         String           @db.VarChar(50)
  containerEquivalent Decimal?         @db.Decimal(10, 2)
  status              InvestorStatus   @default(ACTIVE)
  isActive            Boolean          @default(true)
  notes               String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  dataRequests        DataRequest[]    @relation("InvestorDataRequests")
  assignedExports     ExportShipment[] @relation("InvestorExports")
  user                User?            @relation("InvestorUser")

  @@unique([name, investmentDate])
  @@index([investmentDate])
  @@index([status])
  @@map("investors")
}

model SupplyExport {
  supplyId     Int            @map("supply_id")
  exportId     Int            @map("export_id")
  quantityBags Int
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  allocatedAt  DateTime       @default(now())
  notes        String?
  priority     Int            @default(0)
  export       ExportShipment @relation(fields: [exportId], references: [id], onDelete: Cascade)
  supply       CoalSupply     @relation(fields: [supplyId], references: [id], onDelete: Cascade)

  @@id([supplyId, exportId])
  @@index([allocatedAt])
  @@index([priority])
  @@index([quantityBags])
  @@map("supply_exports")
}

model DataRequest {
  id               Int       @id @default(autoincrement())
  investorId       Int
  dataType         String    @db.VarChar(50)
  recordIds        Int[]
  includeSensitive Boolean   @default(false)
  createdById      Int
  createdAt        DateTime  @default(now())
  status           String    @default("PENDING")
  token            String?   @unique @db.VarChar(255)
  expiresAt        DateTime?
  createdBy        User      @relation("CreatedBy", fields: [createdById], references: [id])
  investor         Investor  @relation("InvestorDataRequests", fields: [investorId], references: [id])

  @@map("data_requests")
}

enum UserRole {
  ADMIN
  STAFF
  INVESTOR
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum PaymentStatus {
  BALANCED
  OVERPAID
  UNDERPAID
}

enum ShipmentStatus {
  PENDING
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum InvestorStatus {
  ACTIVE
  RETURNED
  PARTIAL
}
